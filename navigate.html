<!DOCTYPE html>
<html>
  <head>
    <title>นำทางด้วย AR - เลี้ยวไปตามเส้นทาง</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene embedded arjs="sourceType: webcam; trackingMethod: best;">
      <!-- วงกลมแทนลูกศร -->
      <a-entity
        id="arrow"
        geometry="primitive: sphere; radius: 0.5;"
        material="color: #FF6347; emissive: #FF6347; opacity: 0.8;"
        rotation="0 0 0"
        position="0 0 0"
      >
      </a-entity>

      <!-- กล้อง -->
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <div
      id="status"
      style="
        position: fixed;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 20px;
      "
    >
      กรุณารอการกำหนดทิศทาง...
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const destination = urlParams.get("destination");

      // กำหนดจุดหมาย (จุดที่ต้องเลี้ยว)
      const routePoints = [
        { lat: 18.791915, lon: 98.988959, name: "library" },
        { lat: 18.795, lon: 98.9795, name: "turn left" },
        { lat: 18.796, lon: 98.9793, name: "canteen" },
        { lat: 18.7962, lon: 98.9785, name: "auditorium" },
      ];

      let currentPointIndex = 0;
      let targetCoords = routePoints[currentPointIndex];

      if (!destination || !routePoints.find((point) => point.name === destination)) {
        alert("ไม่พบจุดหมายที่เลือก!");
      }

      const arrow = document.getElementById("arrow");
      const statusElement = document.getElementById("status");

      function computeBearing(lat1, lon1, lat2, lon2) {
        const toRadians = (deg) => (deg * Math.PI) / 180;
        const toDegrees = (rad) => (rad * 180) / Math.PI;

        const dLon = toRadians(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRadians(lat2));
        const x =
          Math.cos(toRadians(lat1)) * Math.sin(toRadians(lat2)) -
          Math.sin(toRadians(lat1)) *
            Math.cos(toRadians(lat2)) *
            Math.cos(dLon);
        const brng = Math.atan2(y, x);
        return (toDegrees(brng) + 360) % 360;
      }

      function moveToNextPoint() {
        currentPointIndex++;
        if (currentPointIndex < routePoints.length) {
          targetCoords = routePoints[currentPointIndex];
        } else {
          statusElement.innerText = "ถึงจุดหมายแล้ว!";
          statusElement.style.color = "green";
        }
      }

      window.addEventListener("gps-camera-update-position", (e) => {
        const userCoords = e.detail.position;

        // คำนวณทิศทางจากตำแหน่งปัจจุบันไปยังจุดถัดไป
        const bearing = computeBearing(
          userCoords.latitude,
          userCoords.longitude,
          targetCoords.lat,
          targetCoords.lon
        );

        const heading = e.detail.heading; // ทิศทางที่กล้องกำลังหัน
        if (heading !== undefined) {
          const relativeBearing = bearing - heading;
          arrow.setAttribute("rotation", `0 ${relativeBearing} 0`);

          const angleDifference = Math.abs(relativeBearing);
          if (angleDifference < 10) {
            statusElement.innerText = `ถึงจุด: ${targetCoords.name}`;
            statusElement.style.color = "green";
            moveToNextPoint(); // เลื่อนไปยังจุดถัดไป
          } else {
            statusElement.innerText = `ทิศทางผิด กรุณาหมุน`;
            statusElement.style.color = "red";
          }
        }
      });
    </script>
  </body>
</html>
